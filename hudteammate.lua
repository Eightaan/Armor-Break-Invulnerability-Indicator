local init_original = HUDTeammate.init

function HUDTeammate:init(...)
	init_original(self, ...)
	if self._main_player then
		self:_init_armor_timer()
	end
end
		
function HUDTeammate:_init_armor_timer()
    self._health_panel = self._health_panel or self._player_panel:child("radial_health_panel")
	self._cooldown_timer = self._health_panel:text({
		name = "cooldown_timer",
		text = "",
		color = Color.white,
		visible = false,
		align = "center",
		vertical = "center",
		y = 10,
		font = tweak_data.hud.medium_font_noshadow,
		font_size = 16,
		layer = 4
	})
	self._cooldown_icon = self._health_panel:bitmap({
		name = "cooldown_icon",
		texture = "guis/dlcs/opera/textures/pd2/specialization/icons_atlas",
		texture_rect = {0, 0, 64, 64},
		valign = "center",
		x = 14,
		y = 15,
		w = 40,
		h = 40,
		color = Color.white,
		visible = false,
		align = "center",
		layer = 3
	})
end

Hooks:PreHook(HUDTeammate, "_create_radial_health", "_create_radial_health_armor_radial", function (self, radial_health_panel)
	self._radial_health_panel = radial_health_panel
	local radial_armor = radial_health_panel:bitmap({
		texture = "guis/textures/pd2/hud_swansong",
		name = "radial_armor",
		blend_mode = "add",
		visible = false,
		render_template = "VertexColorTexturedRadial",
		layer = 5,
		color = Color(1, 0, 0, 0),
		w = radial_health_panel:w(),
		h = radial_health_panel:h()
	})
end)

function HUDTeammate:update_cooldown_timer(t)
    if t and t > 1 and self._cooldown_timer then
        self._cooldown_timer:stop()
        self._cooldown_timer:animate(function(o)
           	o:set_visible(true)
           	local t_left = t
           	while t_left >= 0 and not managers.player:player_unit():character_damage().swansong do
               	t_left = t_left - coroutine.yield()
               	o:set_text(string.format("%.1f", t_left))
				o:set_color(Color.red)
           	end
           	o:set_visible(false)
			self._cooldown_icon:set_visible(false)
        end)
    end
end

function HUDTeammate:animate_invulnerability(duration)
 	self._radial_health_panel:child("radial_armor"):animate(function (o)
	    local icon = self._cooldown_icon 
		local timer = self._cooldown_timer 
   		o:set_color(Color(1, 1, 1, 1))
		timer:set_alpha(0)
		icon:set_visible(true)
		icon:set_alpha(managers.player:has_activate_temporary_upgrade("temporary", "berserker_damage_multiplier") and 0 or 1)
   		o:set_visible(true)
   		over(duration, function (p)
    		o:set_color(Color(1, 1 - p, 1, 1))
			o:set_alpha(managers.player:has_activate_temporary_upgrade("temporary", "berserker_damage_multiplier") and 0 or 1)
    	end)
    	o:set_visible(false)
	    timer:set_alpha(1)
		icon:set_alpha(0.4)
  	end)
end